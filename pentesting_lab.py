#! /usr/bin/env python3

import sys
import os
from itertools import filterfalse
import re
import vagrant



class Host:
    #def __init__(self, name, box_name, provisioning_type):
    def __init__(self, name, box_name):
        self.name = name
        self.box_name = box_name
        self.path = "./"+name
        #TODO: add ansible
        #self.provisioning_type = provisioning_type

    def configure(self):
        os.mkdir(self.path, mode=0o755)
        os.chdir(self.path)
        self.v = vagrant.Vagrant()
        self.v.init(self.box_name)
        os.chdir("..")

    def set_ansible_provisioning(self):
        toadd = """
  config.vm.provision "ansible" do |ansible|
	  ansible.verbose = "v"
	  ansible.playbook = "playbook.yml"
  end
"""
        os.chdir(self.path)
        f = open("Vagrantfile")
        vagrantfile = f.read()
        f.close()
        regex = re.compile("^(\ )*#.*$")
        lines = list(filterfalse(regex.match, vagrantfile.split('\n')))
        vagrantfile = ''.join(lines[:-2])
        vagrantfile += toadd
        vagrantfile += "end"
        print(vagrantfile)
        os.chdir("..")

    def provision(self):
        return False

    def up(self):
        os.chdir(self.path)
        for s in self.v.up(stream_output=True):
            print(s, end='')
        os.chdir("..")

    def halt(self):
        os.chdir(self.path)
        self.v.halt()
        os.chdir("..")

    def cmd(self, command):
        os.chdir(self.path)
        result = self.v.ssh(command=command)
        os.chdir("..")
        return result


def startup():
    f = open("boxes.txt","r")
    boxes = list(filter(None, f.read().split("\n")))
    f.close()
    return boxes


boxes = startup()
index = 1
print("Select box type:")
for b in boxes:
    print(str(index),b)
    index += 1
index = int(input("> ")) - 1
print("Insert host name:")
name = input("> ")


#v = Host(name="machine01", box_name="generic/debian9")
v = Host(name=name, box_name=boxes[index])
v.configure()
v.set_ansible_provisioning()
v.up()
result = v.cmd("whoami")
print(result)
v.halt()

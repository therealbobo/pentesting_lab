#! /usr/bin/env python3

import sys
import os
import re
import vagrant
import subprocess
import core.vmconfig as vmconfig
from core.vde2 import VdeSwitch


base_path = "/tmp/"
cwd = os.getcwd()


class GuestMachine:
    def __init__(self, configuration):
        self.config = configuration
        self.path = base_path + self.config.name

    def setup(self):
        try:
            os.mkdir(self.path, mode=0o755)
        except FileExistsError:
            pass
        os.chdir(self.path)
        self.v = vagrant.Vagrant()
        self.v.init()

        # Writing configuration files
        vagrant_file = open("Vagrantfile","w")
        vagrant_file.write(self.config.vagrantfile())
        vagrant_file.close()
        # TODO: mod for more playbooks
        ansible_playbook = open("general.yml","w")
        ansible_playbook.write(self.config.ansible_playbook())
        ansible_playbook.close()

        os.chdir(cwd)

    def up(self):
        os.chdir(self.path)
        for s in self.v.up(stream_output=True):
            print(s, end='')
        os.chdir(cwd)

    def halt(self):
        os.chdir(self.path)
        self.v.halt()
        os.chdir(cwd)

    def cmd(self, command):
        os.chdir(self.path)
        result = self.v.ssh(command=command)
        os.chdir(cwd)
        return result

    def ssh(self):
        os.chdir(self.path)
        p = subprocess.run("vagrant ssh",shell=True)
        os.chdir(cwd)
        #return result

    def cleanup(self,destroy=True):
        self.halt()
        if destroy:
            os.chdir(self.path)
            self.v.destroy()
            os.chdir(cwd)
            os.rmdir(self.path)






def startup():
    f = open("boxes.txt","r")
    boxes = list(filter(None, f.read().split("\n")))
    f.close()
    return boxes



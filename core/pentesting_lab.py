#! /usr/bin/env python3

import sys
import os
import re
import vagrant
import virtual_machine
from vde2 import VdeSwitch


base_path = "/tmp/"
cwd = os.getcwd()


class GuestMachine:
    def __init__(self, configuration):
        self.config = configuration
        self.path = base_path + self.config.name

    def setup(self):
        try:
            os.mkdir(self.path, mode=0o755)
        except FileExistsError:
            pass
        os.chdir(self.path)
        self.v = vagrant.Vagrant()
        self.v.init()

        # Writing configuration files
        vagrant_file = open("Vagrantfile","w")
        vagrant_file.write(self.config.vagrantfile())
        vagrant_file.close()
        ansible_playbook = open("general.yml","w")
        ansible_playbook.write(self.config.ansible_playbook())
        ansible_playbook.close()

        os.chdir(cwd)

    def up(self):
        os.chdir(self.path)
        for s in self.v.up(stream_output=True):
            print(s, end='')
        os.chdir(cwd)

    def halt(self):
        os.chdir(self.path)
        self.v.halt()
        os.chdir(cwd)

    def cmd(self, command):
        os.chdir(self.path)
        result = self.v.ssh(command=command)
        os.chdir(cwd)
        return result


def startup():
    f = open("boxes.txt","r")
    boxes = list(filter(None, f.read().split("\n")))
    f.close()
    return boxes


boxes = startup()
index = 1
print("Select box type:")
for b in boxes:
    print(str(index),b)
    index += 1
index = int(input("> ")) - 1
print("Insert host name:")
name = input("> ")


ifaces = ['/tmp/switch1','/tmp/switch2']
switches = list()
for i in ifaces:
    s = VdeSwitch(i)
    switches.append(s)
    s.create_switch()

#packages = ['unzip','git','netdiscover']
#packages = ['unzip','git']
#configuration = virtual_machine.VirtualMachineConfiguration(name, boxes[index], False, False, ifaces, packages)
#guest = GuestMachine(configuration)
#guest.setup()
#guest.up()

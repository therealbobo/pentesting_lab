#! /usr/bin/env python3

import os
import json
from prettytable import PrettyTable
from termcolor import colored
import pentesting_lab.core.global_vars as global_vars
import pentesting_lab.core.provisioning_ansible_playbook

switches_path = global_vars.switches_path

class VMConfig:
    def __init__(self, name=None, box="ubuntu/xenial64", cpus=1, memory=512, gui=False, linked_clone=False, network_interfaces=list(), packages=list(), playbooks=list()):
        self.name = name
        self.box = box
        self.cpus = cpus
        self.memory = memory
        self.gui = gui
        self.linked_clone = linked_clone
        self.network_interfaces = [switches_path + '/' + iface for iface in network_interfaces] 
        # TODO
        # packages as maps so they can change state (present/absent)
        self.packages = packages
        # TODO
        # map of ip-ifaces
        #######
        self.playbooks = playbooks

    def add_pkg(package):
        self.packages.append(package)

    #TODO
    def remove_pkg(package):
        self.packages.remove(package)

    def add_iface(self, iface):
        self.network_interfaces.append(switches_path + '/' + iface)

    def remove_iface(self, iface):
        self.network_interfaces.remove(switches_path + '/' + iface)

    def vagrant_config(self):
        config = """
  ###### VAGRANT CONFIG ######
  config.vm.box = "{box}"
  config.vm.define "{name}" do |t|
  end
  config.vm.hostname = "{hostname}"
""".format(box=self.box, name=self.name, hostname=self.name)
        return config

    def iface_config(self, iface):
        base = """
	  # VDE SWICH ({iface})
	  vb.customize ["modifyvm", :id, "--nic{iface_number}","generic"]
	  vb.customize ["modifyvm", :id, "--nicgenericdrv{iface_number}","VDE"]
	  vb.customize ["modifyvm", :id, "--nicproperty{iface_number}","network={iface}"]
"""
        # 2 default ifaces
        iface_number = self.network_interfaces.index(iface) + 3
        return base.format(iface_number=iface_number, iface=iface)

        
    def vb_config(self):
        config = '\n\n  config.vm.provider "virtualbox" do |vb|\n'
        #setting up name
        config += """
	  ###### VIRTUALBOX CONFIG ######
	  # VM NAME
	  vb.name = "{name}"
""".format(name=self.name)
        #setting up gui
        config += """
	  # RESOURCES
	  vb.cpus = {cpus}
	  vb.memory = {memory}
""".format(cpus=str(self.cpus),memory=str(self.memory))
        config += """
	  # GUI MODE
	  vb.gui = {name}
""".format(name=str(self.gui).lower())
        config += """
	  # IMPORTING MODE
	  vb.linked_clone = {linked_clone}
""".format(linked_clone=str(self.linked_clone).lower())
        config += """
	  # SERIAL PORT
          # name = /dev/ttyS0
          # IO address = 0x3F8
          # Interupt Request (IRQ) = 4
          vb.customize ["modifyvm", :id, "--uart1", "0x3f8", "4"]
          vb.customize ["modifyvm", :id, "--uartmode1", "file", "/tmp/{name}_log"]
""".format(name=self.name)
        if len(self.network_interfaces) > 0:
            config += """
	  ###### NETWORK CONFIG ###### """
        for iface in self.network_interfaces:
            config += self.iface_config(iface)
        config += "  end"
        return config

    def ansible_config(self):
        config = """\n\n
  ###### ANSIBLE GENERAL CONFIG ######
  config.vm.provision "ansible" do |ansible|
	   ansible.playbook = "general.yml"
	   ansible.extra_vars = { ansible_python_interpreter:"/usr/bin/python3" }
  end"""
        config += """\n\n
  ###### ANSIBLE CONFIG ######
  """
        # commons ansible playbooks
        for root, _, pb in os.walk(global_vars.ansible_playbooks_comm_path, topdown=False):
            name = root + '/' + pb[0]
            config += """
  config.vm.provision "ansible" do |ansible|
	   ansible.playbook = "{name}\"""".format(name=name)
            config += """
	   ansible.extra_vars = { ansible_python_interpreter:"/usr/bin/python3" }
  end
  """

        for k in self.playbooks:
            name = global_vars.ansible_playbooks_path + '/' + k
            config += """
  config.vm.provision "ansible" do |ansible|
	   ansible.playbook = "{name}\"""".format(name=name)
            config += """
	   ansible.extra_vars = { ansible_python_interpreter:"/usr/bin/python3" }
  end
  """



        return config

    def vagrantfile(self):
        vagrantfile = """Vagrant.configure("2") do |config|\n\n"""
        vagrantfile += self.vagrant_config()
        vagrantfile += self.vb_config()
        vagrantfile += self.ansible_config()
        vagrantfile += "\n\nend"
        return vagrantfile


    def ansible_playbook(self):
        provisioning_playbook = pentesting_lab.core.provisioning_ansible_playbook.ProvisioningPlaybook(self.packages)       
        #self.provisioning_playbook = provisioning_playbook.get_playbook()
        return provisioning_playbook.get_playbook()

    def serialize(self):
        return self.__dict__

    def load(self, json_data):
        self.__dict__ = json.loads(json_data)


    def __repr__(self):
        max_n = len(self.network_interfaces)
        if len(self.packages) > max_n:
            max_n = len(self.packages)

        pkgs = self.packages.copy()
        for i in range(0,max_n-len(self.packages)):
            pkgs.append('')
        ifaces = self.network_interfaces.copy()
        for i in range(0,max_n-len(self.network_interfaces)):
            ifaces.append('')

        box = [self.box]
        for i in range(0,max_n-len(box)):
            box.append('')
        gui = [self.gui]
        for i in range(0,max_n-len(gui)):
            gui.append('')
        linked_clone = [self.linked_clone]
        for i in range(0,max_n-len(linked_clone)):
            linked_clone.append('')


        pt = PrettyTable()
        pt.title = colored(self.name,'red')
        pt.add_column('Box',box)
        pt.add_column('Gui',gui)
        pt.add_column('Linked Clone',linked_clone)
        pt.add_column('IFaces',ifaces)
        pt.add_column('Packages',pkgs)
        return str(pt)
